#!/usr/bin/env ruby

require 'shellwords'
require 'fileutils'

SOCKDIR = "/tmp/dm"
KEYSEQ = "^D"

@method = 'a'

def list
  Dir["#{SOCKDIR}/*"].each_with_index do |dir, ind|
    puts "Socket ##{ind + 1} -> #{dir}"
  end
  exit(0)
end

def usage(excode = 0)
  puts "#{File.basename($PROGRAM_NAME)} [-hl] <alias> [command]"
  exit(excode)
end

FileUtils.mkdir(SOCKDIR) unless File.directory?(SOCKDIR)

usage if ARGV.include?("-h")
list if ARGV.include?("-l")

case ARGV.size
when 0
  usage(1)
when 1
  @method = 'a'
when 2
  @method = 'A'
end

name = ARGV.shift
socket = "#{SOCKDIR}/#{name}"

command = "abduco -e #{KEYSEQ} -#{@method} #{socket} #{ARGV.shelljoin}"

system(command)
